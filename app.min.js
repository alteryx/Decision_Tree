/* Data Items to Initialize */
var itemsToInitialize = {
  curPage: "Home",
  curTab: "model",
  curToggle: "toggle-main",
};

var radioItems = {
  surrogate_use: ['usesurrogate.0', 'usesurrogate.1', 'usesurrogate.2'], 
  splitting_criteria: ['use.gini', 'use.information'],
  surrogate_split_criteria: ['total.correct' , 'percent.correct']
}

var toggleBarItems = {
  model_type: ['auto', 'classification', 'regression'],
  tree_summary: ["Counts", "Proportions"],
  tree_plot_size: ["tree.inches", "tree.centimeters"],
  pruning_plot_size: ["prune.inches", "prune.centimeters"]
}

var displayRules = {
  'div-use.weights': 'use.weights',
  'div-use.weights2': 'use.weights',
  'div-tree.plot': 'tree.plot',
  'div-prune.plot': 'prune.plot',
  'div-treeplot-in': ['tree_plot_size', 'tree.inches'],
  'div-treeplot-cm': ['tree_plot_size', 'tree.centimeters'],
  'div-pruneplot-in': ['pruning_plot_size', 'prune.inches'],
  'div-pruneplot-cm': ['pruning_plot_size', 'prune.centimeters'],
  'div-cp': 'set_cp',
  'show-for-classification': ['model_type', 'classification'],
  'show-on-rules': 'rules',
  'show-on-bandscheck': 'bands_check'
}

Alteryx.Gui.BeforeLoad = function(manager, AlteryxDataItems){
  console.log("Before Load ----");
  var dataItem = makeDataItem(manager, AlteryxDataItems);
  initializeDataItems(dataItem, itemsToInitialize);
  initializeRadioItems(dataItem, radioItems);
  initializeToggleBarItems(dataItem, toggleBarItems);
  dataItem('Model Name', {value: getDefaultModelName()});
};

Alteryx.Gui.AfterLoad = function(manager){
  console.log("After Load ----");
  makeFieldMap('X Vars', ['numeric', 'string']);
  activateDisplayRules(displayRules);
  Object.keys(radioItems).forEach(syncRadio);
  Object.keys(toggleBarItems).forEach(setupToggleBar);
  setupPages()
};

Alteryx.Gui.Annotation = function(manager){
  return manager.GetDataItemByDataName("Model Name").value;
};

function setupPages(){
  var manager = Alteryx.Gui.manager;
  var to = manager.GetDataItem('curPage').getValue()
  switchPage(to);
  $('.switch').on('click', function(){
    var to = $(this).data('page');
    switchPage(to)
  })
  $("document").ready(function(){
    $(".tabs").stick_in_parent();
  })
}

function switchPage(to){
  var manager = Alteryx.Gui.manager;
  var curPage = manager.GetDataItem('curPage');
  var curTab = manager.GetDataItem('curTab');
  var curToggle = manager.GetDataItem('curToggle');
  curPage.setValue(to);
  if (to === "Customize") {
    $('#page-basic').hide();
    $('#page-customize').show();
    handleTabs(curTab);
    handleToggles(curToggle);
  } else {
    $('#page-customize').hide();
    $('#page-basic').show();
    window.dispatchEvent(new Event('resize'));
  }
}

function handleTabs(curTab){
  var modelAlgo =  Alteryx.Gui.manager
    .GetDataItemByDataName("model.algorithm")
  function setTab(){
    $('.tabpage').hide()
    $('.mytab').removeClass('active')
    var activePage = curTab.getValue()
    var pageToShow = ""
    if (activePage === 'model'){
      $("#model-algo").show()
      pageToShow = activePage + '-' + 
        modelAlgo.getValue().toLowerCase().replace(".", "")
    } else {
      $("#model-algo").hide()
      pageToShow = activePage
    }
    $('#tabpage-' + pageToShow).show()
    $('#' + activePage).addClass('active')
  }
  function updateTab(){
    var activePage = $(this).data('page')
    curTab.setValue(activePage)
    setTab()
  }
  setTab()
  $('.mytab').click(updateTab)
  modelAlgo.BindUserDataChanged(function(v){
    setTab()
  })
}
